// ========== METADATOS ==========
    
    async function fetchMetadata() {
      try {
        const response = await fetch(METADATA_URL, {
          method: "GET",
          mode: "cors",
          cache: "no-store",
          headers: {
            "Accept": "application/json",
            "Cache-Control": "no-cache"
          }
        });

        const data = await response.json();
        
        // El servidor Icecast puede devolver 'source' como objeto o array
        let source = data.icestats?.source;
        
        // Si es un array, tomar el primer elemento
        if (Array.isArray(source)) {
          source = source[0];
        }

        if (!source || !source.title) {
          updateDisplay('LEX RADIO', 'EN VIVO', DEFAULT_IMAGE);
          return;
        }

        // El título viene en formato "Artista - Canción"
        const fullTitle = source.title || 'LEX RADIO';
        
        // Separar artista y canción si está en formato "Artista - Canción"
        let artist = 'EN VIVO';
        let song = fullTitle;
        
        if (fullTitle.includes(' - ')) {
          const parts = fullTitle.split(' - ');
          artist = parts[0].trim();
          song = parts[1].trim();
        }

        updateDisplay(song, artist);
        
        // Buscar carátula solo si hay artista y canción válidos
        if (artist !== 'EN VIVO' && song) {
          fetchAlbumArt(artist, song);
        }

      } catch (error) {
        console.error("Error cargando metadata:", error);
        updateDisplay('LEX RADIO', 'EN VIVO', DEFAULT_IMAGE);
      }
    }

    function updateDisplay(song, artist, artwork) {
      songTitle.textContent = song;
      artistName.textContent = artist;
      if (artwork) albumArt.src = artwork;
    }

    async function fetchAlbumArt(artist, song) {
      try {
        const query = encodeURIComponent(`${artist} ${song}`);
        const res = await fetch(`https://itunes.apple.com/search?term=${query}&limit=1&entity=song`);
        const data = await res.json();
        
        if (data.results && data.results.length > 0) {
          const artwork = data.results[0].artworkUrl100.replace('100x100', '600x600');
          if (albumArt.src !== artwork) {
            albumArt.style.opacity = '0.5';
            albumArt.src = artwork;
            setTimeout(() => { albumArt.style.opacity = '1'; }, 300);
          }
        } else {
          albumArt.src = DEFAULT_IMAGE;
        }
      } catch (err) {
        console.error('Error buscando carátula:', err);
        albumArt.src = DEFAULT_IMAGE;
      }
    }

    function startMetadataFetch() {
      fetchMetadata();
      if (metadataInterval) clearInterval(metadataInterval);
      metadataInterval = setInterval(fetchMetadata, 10000);
    }

    // ========== ERROR HANDLING ==========
    audio.addEventListener('error', () => {
      playBtn.innerHTML = '▶️';
      isPlaying = false;
      isLoading = false;
      statusText.textContent = '❌ Error de transmisión';
      stopVisualizer();
      if (metadataInterval) {
        clearInterval(metadataInterval);
        metadataInterval = null;
      }
      albumArt.classList.remove('playing');
    });

    // ========== PARTÍCULAS ==========
    function createParticles() {
      const particles = document.getElementById('particles');
      const particleCount = 50;
      
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particles.appendChild(particle);
      }
    }

    // ========== PWA INSTALL ==========
    let deferredPrompt;

    if (window.matchMedia('(display-mode: standalone)').matches) {
      if (installButton) installButton.style.display = 'none';
      if (installLexRadioBtn) installLexRadioBtn.style.display = 'none';
    }

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (installButton) installButton.classList.add('show');
    });

    async function triggerInstall() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        
        if (outcome === 'accepted') {
          console.log('PWA instalada');
          if (installButton) installButton.style.display = 'none';
          if (installLexRadioBtn) installLexRadioBtn.style.display = 'none';
        }
        deferredPrompt = null;
      } else {
        const userAgent = navigator.userAgent.toLowerCase();
        let message = '';
        
        if (window.matchMedia('(display-mode: standalone)').matches) {
          message = '¡La app ya está instalada!';
        } else if (userAgent.includes('chrome') && !userAgent.includes('edg')) {
          message = 'Para instalar:\n1. Presiona el menú (⋮) arriba a la derecha\n2. Selecciona "Agregar a pantalla de inicio" o "Instalar app"';
        } else if (userAgent.includes('safari') && !userAgent.includes('chrome')) {
          message = 'Para instalar en Safari:\n1. Presiona el botón de compartir\n2. Selecciona "Agregar a pantalla de inicio"';
        } else if (userAgent.includes('firefox')) {
          message = 'Para instalar en Firefox:\n1. Presiona el menú (⋮)\n2. Selecciona "Instalar"';
        } else {
          message = 'Abre el menú de tu navegador y busca la opción "Agregar a pantalla de inicio" o "Instalar"';
        }
        
        alert(message);
      }
    }

    if (installButton) {
      installButton.addEventListener('click', triggerInstall);
    }
    if (installLexRadioBtn) {
      installLexRadioBtn.addEventListener('click', triggerInstall);
    }

    window.addEventListener('appinstalled', () => {
      if (installButton) installButton.style.display = 'none';
      if (installLexRadioBtn) installLexRadioBtn.style.display = 'none';
      console.log('PWA instalada exitosamente');
    });

    // ========== SMOOTH SCROLL ==========
    document.querySelectorAll('nav a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // ========== AUTO-RECUPERACIÓN ==========
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible' && isPlaying) {
        audio.play().catch(e => console.log('No se pudo reanudar:', e));
      }
    });

    // ========== GUARDAR/CARGAR CONFIGURACIÓN ==========
    function saveEqSettings() {
      const settings = {
        preset: currentPreset,
        values: [...eqValues],
        customPreset: [...eqPresets.custom],
        volume: audio.volume
      };
      localStorage.setItem('lexradio_eq_settings', JSON.stringify(settings));
    }

    function loadEqSettings() {
      try {
        const saved = localStorage.getItem('lexradio_eq_settings');
        if (saved) {
          const settings = JSON.parse(saved);
          
          if (settings.customPreset) {
            eqPresets.custom = settings.customPreset;
          }
          
          if (settings.volume !== undefined) {
            audio.volume = settings.volume;
            volumeSlider.value = settings.volume;
            updateVolumeSlider();
          }
          
          if (settings.preset && eqPresets[settings.preset]) {
            setTimeout(() => applyPreset(settings.preset), 100);
          } else {
            setTimeout(() => applyPreset('flat'), 100);
          }
        } else {
          setTimeout(() => applyPreset('flat'), 100);
        }
      } catch (e) {
        console.log('No se pudo cargar configuración guardada');
        setTimeout(() => applyPreset('flat'), 100);
      }
    }

    volumeSlider.addEventListener('change', saveEqSettings);

    // ========== PRECARGA DE METADATOS ==========
    document.addEventListener('DOMContentLoaded', () => {
      console.log('✅ LEX RADIO cargado - Metadatos listos');
      fetchMetadata();
      loadEqSettings();
      loadEqCollapseState();
    });
  </script>

</body>
</html>
